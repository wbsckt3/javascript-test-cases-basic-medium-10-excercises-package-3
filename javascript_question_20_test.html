
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactorii</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/cjs/index.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
// Encapsulating the function in shape namespace
var shape = shape || {};

shape.StringUtils = {
  isValidInternationalPhoneNumber: function(phoneNumber) {
    // Define the regular expression pattern for a valid international phone number
    const regexPattern = /^\+\d{1,3}[-\s]?\(?\d{1,4}\)?[-\s]?\d{1,4}[-\s]?\d{1,4}[-\s]?\d{1,4}$/;

    // Remove any non-digit characters except for '+' at the start
    const normalizedNumber = phoneNumber.replace(/(?!^\+)[^\d]/g, '');

    // Check if the normalized number matches the regex pattern and its length is within valid range
    return regexPattern.test(phoneNumber) && normalizedNumber.length >= 8 && normalizedNumber.length <= 18;
  }
};

// Console logs for testing the function
console.log("Test: +1 234 567 890 should be valid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+1 234 567 890")); // Expected: true

console.log("Test: +44 20 1234 5678 should be valid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+44 20 1234 5678")); // Expected: true

console.log("Test: +1-(123)-456-7890 should be valid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+1-(123)-456-7890")); // Expected: true

console.log("Test: +123 456 should be invalid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+123 456")); // Expected: false

console.log("Test: +12 345 678 901 234 should be valid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+12 345 678 901 234")); // Expected: true

console.log("Test: Missing country code should be invalid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("123-456-7890")); // Expected: false

console.log("Test: Too many digits in local number should be invalid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("+1 234 567 890 1234 5678")); // Expected: false

console.log("Test: Random string should be invalid");
console.log(shape.StringUtils.isValidInternationalPhoneNumber("hello world!")); // Expected: false

        </textarea>
	<img id="logo" src="https://wbsckt3.github.io/javascript-test-cases-basic-medium-10-excercises-package/logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
	    <h5>Challenge: String Manipulation and Regular Expressions</h5>
            <div id="modify-message">In programming, especially when working with strings, regular expressions (regex) are a powerful tool for searching, matching, and manipulating text...</div>
	    <button id="send-response-button" onClick= "guardarResultados()">Send Response</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Concept</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    	 // Obtener el par√°metro `token` de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	    // Realiza una solicitud al servicio externo para validar el token
	    fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	    .then(response => response.json())
	    .then(data => {
	        if (data.valid) {
	            console.log(data.valid);
	             // Decodifica el token para obtener el payload
                     const decodedToken = decodeJwtResponse(token);
         	     const recipeId = decodedToken._id; // Aseg√∫rate de usar el nombre correcto del campo en el payload
                     console.log('Recipe ID:', recipeId);
		     // Almacenar recipeId en local storage
                     localStorage.setItem('recipeId', recipeId);
	             // Llama a la funci√≥n de prueba
	             test_cases_scenario();
	        } else {
	            console.log(data.valid);
	            document.body.innerHTML = 'Access denied. Invalid token.';
	        }
	    }).catch(error => {
	        document.body.innerHTML = 'Error validating token.';
	        console.error('Error:', error);
	    });
    } else {
	    document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	    
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'javascript',
            lineWrapping: true,
            scrollbarStyle: 'null'
        });
        
        var modal_click_message = `This problem challenges you to continue coding the function to sort an array of positive integers...`;
        var error_message = ` String Manipulation and Regular Expressions<br><br>
In programming, especially when working with strings, regular expressions (regex) are a powerful tool for searching, matching, and manipulating text. This challenge aims to test your understanding of regex patterns, string methods, and conditional logic in JavaScript.
<br><br>
Task: Validate International Phone Numbers<br><br>
Your task is to implement a function that validates international phone numbers. The function should check if a given string is a valid phone number according to the following criteria:
<br><br>
- The number must start with a + followed by the country code and then the local number.<br>
- The country code can have 1 to 3 digits.<br>
- The local number must be 7 to 15 digits long.<br>
- The number can contain spaces, dashes, or parentheses, but these should be ignored when checking the validity.<br><br>
Examples of valid numbers:
<br><br>
+1 234 567 890<br>
+44 20 1234 5678<br>
+1-(123)-456-7890<br><br>Test Cases:<br><br>
+1 234 567 890 should be valid<br>
+44 20 1234 5678 should be valid<br>
+1-(123)-456-7890 should be valid<br>
+123 456 should be invalid (too short)<br>
+12 345 678 901 234 should be valid<br>
123-456-7890 should be invalid (missing country code)<br>
+1 234 567 890 1234 5678 should be invalid (too long)<br>
"hello world!" should be invalid (not a number)<br>`;

	var success_message = `üöÄ Well done! You've successfully navigated through the complexities of regular expressions and phone number validation. 
 This exercise wasn't just about finding the right pattern; it was about sharpening your skills and deepening your understanding of string manipulation and 
 pattern recognition. Keep pushing those boundaries and exploring the vast possibilities of programming. You're on a path to becoming a master of code! üåüüëèüë®‚Äçüíªüë©‚Äçüíª `
        
        // Funci√≥n para mostrar el modal con el mensaje de error
        document.getElementById('modify-message').addEventListener('click', function() {
            $('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
            $('#errorMessageModal').modal('show'); // Muestra el modal
        });

        function logToConsole(message, color) {
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            if (color) {
                messageElement.style.color = color;
                messageElement.style.fontWeight = 'bold';
            }
            consoleElement.appendChild(messageElement);
        }

        document.getElementById('run-button').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('console').innerHTML = '';
            document.getElementById('mocha').innerHTML = '';
            mocha.suite.suites = []; // Clear previous test cases
            // Get the user's code from the editor
            const userCode = editor.getValue();
		
            // Redirect console.log to custom console
	    const output = [];
	    const originalConsoleLog = console.log;
	    /*console.log = function(message) {
		output.push(message);
		logToConsole(message);
	    };*/
	    // Show "Ejecutando tests..." message and delay tests
	    logToConsole('Running tests....', '#67e810');
		console.log = function(...args) {
                const message = args.join(' ');
                originalConsoleLog.apply(console, args); // Still log to the original console
                logToConsole(message);
            };
		
  	    setTimeout(() => {
            	// Evaluate the user's code
            	try {
                    const userFunction = new Function(userCode + '; return shape;');  
                    const shape = userFunction();
                    // Define test cases
                    const expect = chai.expect;
		    const assert = chai.assert;	

describe("shape.StringUtils.isValidInternationalPhoneNumber Method", function() {
  it("should validate the phone number +1 234 567 890", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+1 234 567 890");
    assert.strictEqual(result, true);
  });

  it("should validate the phone number +44 20 1234 5678", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+44 20 1234 5678");
    assert.strictEqual(result, true);
  });

  it("should validate the phone number +1-(123)-456-7890", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+1-(123)-456-7890");
    assert.strictEqual(result, true);
  });

  it("should invalidate the phone number +123 456 (too short)", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+123 456");
    assert.strictEqual(result, false);
  });

  it("should validate the phone number +12 345 678 901 234", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+12 345 678 901 234");
    assert.strictEqual(result, true);
  });

  it("should invalidate the phone number 123-456-7890 (missing country code)", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("123-456-7890");
    assert.strictEqual(result, false);
  });

  it("should invalidate the phone number +1 234 567 890 1234 5678 (too long)", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("+1 234 567 890 1234 5678");
    assert.strictEqual(result, false);
  });

  it("should invalidate the input 'hello world!' (not a number)", function() {
    const result = shape.StringUtils.isValidInternationalPhoneNumber("hello world!");
    assert.strictEqual(result, false);
  });
});

		// Variable para rastrear el estado de los tests
                let allTestsPassed = true;	
 	        // Run Mocha tests
                mocha.run()
                    .on('test', function(test) {
                        logToConsole('‚Ä¢ Running test: ' + test.title);
                    })
                    .on('test end', function(test) {
                        logToConsole('‚Ä¢ Test finished: ' + test.title);
                    })
                    .on('pass', function(test) {
                        logToConsole('‚Ä¢ Test passed: ' + test.title);
                    })
                    .on('fail', function(test, err) {
			logToConsole('‚Ä¢ Test failed: ' + test.title + ' - ' + err.message);
			success_message = modal_click_message;
			const runButton = document.getElementById('run-button');
			runButton.innerText = 'Reintentar';
			runButton.style.backgroundColor = '#ff0000ad';
			runButton.onclick = function() {
			    window.location.reload();
			};
			allTestsPassed = false; // Si cualquier test falla, actualizamos la variable	
		     })
		     .on('end', function() {
			logToConsole('‚Ä¢ All tests finished!');
			document.getElementById('modify-message').innerText = success_message;
			document.getElementById('modify-message').style.display = 'block';
			document.getElementById('modify-message').style.color = 'black';
			if (allTestsPassed) {
		               const sendResponseButton = document.getElementById('send-response-button');
		               sendResponseButton.classList.add('enabled');
		        } 
		     });

            } catch (e) {
                console.error('Error evaluating user code:', e);
                logToConsole('Error: ' + e.message, 'red');
            } finally {
                // Restore original console.log
                console.log = originalConsoleLog;
            }
			
		}, 3000); // 3 seconds delay
        });
    }
	    
    async function guardarResultados() {
	    const formData = JSON.parse(localStorage.getItem("formData"));
	    const email = formData ? formData.Email : null;
            const recipeId = localStorage.getItem('recipeId'); // Recuperar recipeId de local storage
	    // Crear el objeto que se guardar√° en la base de datos
	    // Obtener la URL actual
	    const currentUrl = window.location.href;
	    // Crear un objeto URL
	    const url = new URL(currentUrl);
	    // Eliminar el par√°metro 'token' de la query string
	    url.searchParams.delete('token');
	    // Obtener el pathname sin el token
            const urlWithoutToken = url.pathname.split('/').pop();
	    const recipeCalificadaOk = {
	        recipeId: recipeId,
		url: urlWithoutToken,
	        date: new Date().toISOString()
	    };
	    try {
	        const response = await fetch('https://www.refactorii.com/updateOneGoogleSigninUserRecipe', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            //body: JSON.stringify({ Email: email, recipeCalificadaOk: recipeId })
		    body: JSON.stringify({ Email: email, recipeCalificadaOk })	
	        });
	        const data = await response.json();
	        console.log('Server responds:', "Ok");
		// Redirecci√≥n a la p√°gina original
                window.location.href = `https://www.refactorii.com/recipes/${recipeId}`;
	    } catch (error) {
	        console.error('Error sending the results to the server:', error);
	    }
    }

    function decodeJwtResponse(token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
	    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
	        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	    }).join(''));
	    return JSON.parse(jsonPayload);
    }
    </script>
</body>
</html>
