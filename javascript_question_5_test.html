<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactorii</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/cjs/index.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
const shape = {
/* Challenge: Create a Function Generator
Challenge Description
Develop a function that generates an array of functions, each of which returns a different value when invoked. The value should correspond to its position in the sequence, demonstrating the use of closures in JavaScript.
Specifications
Function: buildFun
Parameters:
N: The number of functions to generate.
Returns: An array of N functions.
Behavior: The function should create an array of N functions. Each function, when called, should return its corresponding index from the array (i.e., the value it was assigned in the for loop). */
};
// Test cases:
const functionsArray = shape.buildFun(5);
functionsArray.forEach(func => console.log(func())); // Should print 0, 1, 2, 3, 4
        </textarea>
	<img id="logo" src="https://wbsckt3.github.io/javascript-test-cases-basic-medium-10-excercises-package/logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
	    <h5>Exercise 5: Closures in javascript</h5>
            <div id="modify-message">A closure is a function that retains access to its lexical scope, even when the function...</div>
	    <button id="send-response-button" onClick= "guardarResultados()">Send response</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Concept explanation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
       const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	    // Realiza una solicitud al servicio externo para validar el token
	    fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	    .then(response => response.json())
	    .then(data => {
	        if (data.valid) {
	            console.log(data.valid);
	             // Decodifica el token para obtener el payload
                     const decodedToken = decodeJwtResponse(token);
         	     const recipeId = decodedToken._id; // AsegÃºrate de usar el nombre correcto del campo en el payload
                     console.log('Recipe ID:', recipeId);
		     // Almacenar recipeId en local storage
                     localStorage.setItem('recipeId', recipeId);
	             // Llama a la funciÃ³n de prueba
	             test_cases_scenario();
	        } else {
	            console.log(data.valid);
	            document.body.innerHTML = 'Access denied. Invalid token.';
	        }
	    }).catch(error => {
	        document.body.innerHTML = 'Error validating token.';
	        console.error('Error:', error);
	    });
    } else {
	    document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	    
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'javascript',
            lineWrapping: true,
            scrollbarStyle: 'null'
        });
        
        var modal_click_message = `A closure is a function that retains access to its lexical scope, even when the function...`;
        var error_message = `Concept Explanation:<br><br>

A closure is a function that retains access to its lexical scope, even when the function is executed outside that scope. This feature allows the inner function to "remember" the environment in which it was created.
Function buildFun(N):
<br><br>
This function creates an array of functions.<br>
It uses a for loop to create N functions, each of which returns the current value of the loop variable i.<br>
The let keyword ensures that each function captures the correct value of i due to block scoping.<br>
Test Case:
<br><br>
We create an array of functions by calling shape.buildFun(5).<br>
We then iterate over this array and invoke each function, printing the result to the console.<br>
The expected output is the sequence of numbers from 0 to N-1.`;  
	var success_message = `ðŸŽ‰ Awesome job! You've nailed it! ðŸš€ Your hard work and dedication are paying off. Keep up the great work, 
        and don't hesitate to submit your answer! ðŸ’ªðŸŒŸ #CodingHero #KeepGoing`
        
        // FunciÃ³n para mostrar el modal con el mensaje de error
        document.getElementById('modify-message').addEventListener('click', function() {
            $('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
            $('#errorMessageModal').modal('show'); // Muestra el modal
        });

        function logToConsole(message, color) {
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            if (color) {
                messageElement.style.color = color;
                messageElement.style.fontWeight = 'bold';
            }
            consoleElement.appendChild(messageElement);
        }

        document.getElementById('run-button').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('console').innerHTML = '';
            document.getElementById('mocha').innerHTML = '';
            mocha.suite.suites = []; // Clear previous test cases
            // Get the user's code from the editor
            const userCode = editor.getValue();
            // Redirect console.log to custom console
	    const output = [];
	    const originalConsoleLog = console.log;
	    console.log = function(message) {
		output.push(message);
		logToConsole(message);
	    };
	    // Show "Ejecutando tests..." message and delay tests
	    logToConsole('Running tests...', 'green');
  	    setTimeout(() => {
            	// Evaluate the user's code
            	try {
                    const userFunction = new Function(userCode + '; return shape;');
                    const shape = userFunction();
                    // Define test cases
                    const expect = chai.expect;
                    

describe('shape.buildFun()', function() {

   let loggedValues;
  let originalConsoleLog;

  beforeEach(function() {
    // Almacenar la funciÃ³n original de console.log y los valores registrados
    loggedValues = [];
    originalConsoleLog = console.log;
    console.log = (...args) => {
      loggedValues.push(args[0]); // Captura el valor registrado
      originalConsoleLog.apply(console, args); // Llama al original console.log
    };
  });

  afterEach(function() {
    // Restaura console.log despuÃ©s de cada prueba
    console.log = originalConsoleLog;
  });
	
  it('should return functions that return correct numbers', function() {
    const functionsArray = shape.buildFun(5);
    const output = functionsArray.map(func => func());
    expect(output).to.eql([0, 1, 2, 3, 4]);
  });
});
			
		// Variable para rastrear el estado de los tests
                let allTestsPassed = true;	
                // Run Mocha tests
                mocha.run()
                    .on('test', function(test) {
                        logToConsole('â€¢ Running test: ' + test.title);
                    })
                    .on('test end', function(test) {
                        logToConsole('â€¢ Test finished: ' + test.title);
                    })
                    .on('pass', function(test) {
                        logToConsole('â€¢ Test passed: ' + test.title);
                    })
                    .on('fail', function(test, err) {
			logToConsole('â€¢ Test failed: ' + test.title + ' - ' + err.message);
			success_message = modal_click_message;
			const runButton = document.getElementById('run-button');
			runButton.innerText = 'Retry';
			runButton.style.backgroundColor = '#ff0000ad';
			runButton.onclick = function() {
			    window.location.reload();
			};
			allTestsPassed = false; // Si cualquier test falla, actualizamos la variable	
		     })
		     .on('end', function() {
			logToConsole('â€¢ All tests finished!');
			document.getElementById('modify-message').innerText = success_message;
			document.getElementById('modify-message').style.display = 'block';
			document.getElementById('modify-message').style.color = 'black';
			if (allTestsPassed) {
		               const sendResponseButton = document.getElementById('send-response-button');
		               sendResponseButton.classList.add('enabled');
		        } 
		     });

            } catch (e) {
                console.error('Error evaluating user code:', e);
                logToConsole('Error: ' + e.message, 'red');
            } finally {
                // Restore original console.log
                console.log = originalConsoleLog;
            }
			
		}, 3000); // 3 seconds delay
        });
    }
	    
    async function guardarResultados() {
	    const formData = JSON.parse(localStorage.getItem("formData"));
	    const email = formData ? formData.Email : null;
            const recipeId = localStorage.getItem('recipeId'); // Recuperar recipeId de local storage
	    // Crear el objeto que se guardarÃ¡ en la base de datos
	    // Obtener la URL actual
	    const currentUrl = window.location.href;
	    // Crear un objeto URL
	    const url = new URL(currentUrl);
	    // Eliminar el parÃ¡metro 'token' de la query string
	    url.searchParams.delete('token');
	    // Obtener el pathname sin el token
            const urlWithoutToken = url.pathname.split('/').pop();
	    const recipeCalificadaOk = {
	        recipeId: recipeId,
		url: urlWithoutToken,
	        date: new Date().toISOString()
	    };
	    try {
	        const response = await fetch('https://www.refactorii.com/updateOneGoogleSigninUserRecipe', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            //body: JSON.stringify({ Email: email, recipeCalificadaOk: recipeId })
		    body: JSON.stringify({ Email: email, recipeCalificadaOk })	
	        });
	        const data = await response.json();
	        console.log('Server responds:', "Ok");
		// RedirecciÃ³n a la pÃ¡gina original
                window.location.href = `https://www.refactorii.com/recipes/${recipeId}`;
	    } catch (error) {
	        console.error('Error sending the results to the server:', error);
	    }
    }

    function decodeJwtResponse(token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
	    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
	        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	    }).join(''));
	    return JSON.parse(jsonPayload);
    }
    </script>
</body>
</html>
