<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refactorii</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>  
    <link rel="stylesheet" href="https://wbsckt3.github.io/mocha_test_cases_styles_2/style.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuetify@2.6.3/dist/vuetify.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vuex@3.6.2/dist/vuex.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.4.0/mocha.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.3.4/chai.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jwt-decode@4.0.0/build/cjs/index.min.js"></script>
</head>
<body>
    <div id="editor-container">
        <textarea id="code-editor">
// Base Classes
class Marine {
  attack(target) {
    target.health -= 6;
  }
}
class Zealot {
  attack(target) {
    target.health -= 8;
  }
}
class Zergling {
  attack(target) {
    target.health -= 5;
  }
}
// Mario and Attack Strategies
class Mario {
  constructor() {
    this.attackStrategy = new StandardAttack();
  }
  setAttackStrategy(strategy) {
    this.attackStrategy = strategy;
  }
  attack(target) {
    target.health -= this.attackStrategy.execute();
  }
}
class StandardAttack {
  execute() {
    console.log('Mamamia!');
    return 3;
  }
}
class PowerUpAttack {
  execute() {
    console.log('Super Mamamia!');
    return 6;
  }
}
class UltimateAttack {
  execute() {
    console.log('Ultimate Mamamia!');
    return 10;
  }
}
// Ensure shape is defined
var shape = shape || {};
// MarioAdapter: Adapts Mario's attack strategy
shape.MarioAdapter = class {
  constructor(mario) {
    this.mario = mario;
  }
  attack(target) {
    this.mario.attack(target);
  }
};
// Example usage:
const target = { health: 100 };
const mario = new Mario();
// Set different strategies
mario.setAttackStrategy(new StandardAttack()); // Change strategy as needed
const marioAdapter = new shape.MarioAdapter(mario);
marioAdapter.attack(target);
console.log(`Target health after Mario's attack: ${target.health}`);
// Set another strategy and attack
mario.setAttackStrategy(new UltimateAttack());
marioAdapter.attack(target);
console.log(`Target health after Mario's ultimate attack: ${target.health}`);

        </textarea>
	<img id="logo" src="logo_refactorii.png" alt="Logo Refactorii">
        <button id="run-button">Run</button>
    </div>
    <div id="app-container">
        <div id="app">
	    <h5>Challenge: Strategy Pattern</h5>
            <div id="modify-message">The Adapter Design Pattern allows integrating an external character or component into an existing system, ...</div>
	    <button id="send-response-button" onClick= "guardarResultados()">Send Response</button>
        </div>
    </div>
    <div id="console-container"><div id="console"></div></div>
    <div id="mocha-container"><div id="mocha"></div></div>
    <script>mocha.setup('bdd');</script>

    <!-- Modal -->
    <div class="modal fade" id="errorMessageModal" tabindex="-1" role="dialog" aria-labelledby="errorMessageModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="errorMessageModalLabel">Concept</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body" id="errorMessageModalBody">
                    <!-- Contenido del mensaje de error -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <script>
    	 // Obtener el parÃ¡metro `token` de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');
    if (token) {
	    // Realiza una solicitud al servicio externo para validar el token
	    fetch(`https://www.refactorii.com/validate-token?token=${token}`)
	    .then(response => response.json())
	    .then(data => {
	        if (data.valid) {
	            console.log(data.valid);
	             // Decodifica el token para obtener el payload
                     const decodedToken = decodeJwtResponse(token);
         	     const recipeId = decodedToken._id; // AsegÃºrate de usar el nombre correcto del campo en el payload
                     console.log('Recipe ID:', recipeId);
		     // Almacenar recipeId en local storage
                     localStorage.setItem('recipeId', recipeId);
	             // Llama a la funciÃ³n de prueba
	             test_cases_scenario();
	        } else {
	            console.log(data.valid);
	            document.body.innerHTML = 'Access denied. Invalid token.';
	        }
	    }).catch(error => {
	        document.body.innerHTML = 'Error validating token.';
	        console.error('Error:', error);
	    });
    } else {
	    document.body.innerHTML = 'Access denied. No token provided.';
    }
    function test_cases_scenario(){	    
        const editor = CodeMirror.fromTextArea(document.getElementById('code-editor'), {
            lineNumbers: true,
            mode: 'javascript',
            lineWrapping: true,
            scrollbarStyle: 'null'
        });
        
        var modal_click_message = `This problem challenges you to continue coding the function to sort an array of positive integers...`;
        var error_message = `Description:<br><br>
	The Adapter Design Pattern allows integrating an external character or component into an existing system, making it compatible without 
        altering its source code. In this challenge, we'll use this pattern to adapt a non-standard character, Mario, into a system that expects a common interface for attack actions.
	<br><br>
	Task:
	<br><br>
	Create an adapter class, MarioAdapter, that allows a Mario instance to be used like other unit classes (Marine, Zealot, Zergling). The adapter should allow Mario to "attack" by leveraging his jumpAttack method.`;       
	var success_message = `Congratulations on completing this challenging task! ðŸŽ‰ You've successfully applied the Adapter Design Pattern, a crucial concept in software design. By adapting Mario's unique abilities into a common interface, 
        you've demonstrated a deep understanding of how to integrate diverse components seamlessly. `
        
        // FunciÃ³n para mostrar el modal con el mensaje de error
        document.getElementById('modify-message').addEventListener('click', function() {
            $('#errorMessageModalBody').html(error_message); // Coloca el contenido del error en el cuerpo del modal
            $('#errorMessageModal').modal('show'); // Muestra el modal
        });

        function logToConsole(message, color) {
            const consoleElement = document.getElementById('console');
            const messageElement = document.createElement('div');
            messageElement.textContent = message;
            if (color) {
                messageElement.style.color = color;
                messageElement.style.fontWeight = 'bold';
            }
            consoleElement.appendChild(messageElement);
        }

        document.getElementById('run-button').addEventListener('click', function() {
            // Clear previous results
            document.getElementById('console').innerHTML = '';
            document.getElementById('mocha').innerHTML = '';
            mocha.suite.suites = []; // Clear previous test cases
            // Get the user's code from the editor
            const userCode = editor.getValue();
		
            // Redirect console.log to custom console
	    const output = [];
	    const originalConsoleLog = console.log;
	    /*console.log = function(message) {
		output.push(message);
		logToConsole(message);
	    };*/
	    // Show "Ejecutando tests..." message and delay tests
	    logToConsole('Running tests....', '#67e810');
		console.log = function(...args) {
                const message = args.join(' ');
                originalConsoleLog.apply(console, args); // Still log to the original console
                logToConsole(message);
            };
		
  	    setTimeout(() => {
            	// Evaluate the user's code
            	try {
                    const userFunction = new Function(userCode + '; return shape;');  
                    const shape = userFunction();
                    // Define test cases
                    const expect = chai.expect;
		    const assert = chai.assert;	

describe('MarioAdapter with Strategy Pattern', function() {

  // Define the classes within the test suite
  class Marine {
    attack(target) {
      target.health -= 6;
    }
  }
  class Zealot {
    attack(target) {
      target.health -= 8;
    }
  }
  class Zergling {
    attack(target) {
      target.health -= 5;
    }
  }
  class Mario {
    jumpAttack() {
      console.log('Mamamia!');
      return 3;
    }
  }
	
	
  it('should correctly apply the StandardAttack strategy', function() {
    const target = { health: 100 };
    const mario = new Mario();
    mario.setAttackStrategy(new StandardAttack());
    const marioAdapter = new shape.MarioAdapter(mario);

    marioAdapter.attack(target);
    console.log(`Target health after Mario's standard attack: ${target.health}`);
    assert.strictEqual(target.health, 97); // 100 - 3
  });

  it('should correctly apply the PowerUpAttack strategy', function() {
    const target = { health: 100 };
    const mario = new Mario();
    mario.setAttackStrategy(new PowerUpAttack());
    const marioAdapter = new shape.MarioAdapter(mario);

    marioAdapter.attack(target);
    console.log(`Target health after Mario's power-up attack: ${target.health}`);
    assert.strictEqual(target.health, 94); // 100 - 6
  });

  it('should correctly apply the UltimateAttack strategy', function() {
    const target = { health: 100 };
    const mario = new Mario();
    mario.setAttackStrategy(new UltimateAttack());
    const marioAdapter = new shape.MarioAdapter(mario);

    marioAdapter.attack(target);
    console.log(`Target health after Mario's ultimate attack: ${target.health}`);
    assert.strictEqual(target.health, 90); // 100 - 10
  });
});


		// Variable para rastrear el estado de los tests
                let allTestsPassed = true;	
 	        // Run Mocha tests
                mocha.run()
                    .on('test', function(test) {
                        logToConsole('â€¢ Running test: ' + test.title);
                    })
                    .on('test end', function(test) {
                        logToConsole('â€¢ Test finished: ' + test.title);
                    })
                    .on('pass', function(test) {
                        logToConsole('â€¢ Test passed: ' + test.title);
                    })
                    .on('fail', function(test, err) {
			logToConsole('â€¢ Test failed: ' + test.title + ' - ' + err.message);
			success_message = modal_click_message;
			const runButton = document.getElementById('run-button');
			runButton.innerText = 'Reintentar';
			runButton.style.backgroundColor = '#ff0000ad';
			runButton.onclick = function() {
			    window.location.reload();
			};
			allTestsPassed = false; // Si cualquier test falla, actualizamos la variable	
		     })
		     .on('end', function() {
			logToConsole('â€¢ All tests finished!');
			document.getElementById('modify-message').innerText = success_message;
			document.getElementById('modify-message').style.display = 'block';
			document.getElementById('modify-message').style.color = 'black';
			if (allTestsPassed) {
		               const sendResponseButton = document.getElementById('send-response-button');
		               sendResponseButton.classList.add('enabled');
		        } 
		     });

            } catch (e) {
                console.error('Error evaluating user code:', e);
                logToConsole('Error: ' + e.message, 'red');
            } finally {
                // Restore original console.log
                console.log = originalConsoleLog;
            }
			
		}, 3000); // 3 seconds delay
        });
    }
	    
    async function guardarResultados() {
	    const formData = JSON.parse(localStorage.getItem("formData"));
	    const email = formData ? formData.Email : null;
            const recipeId = localStorage.getItem('recipeId'); // Recuperar recipeId de local storage
	    // Crear el objeto que se guardarÃ¡ en la base de datos
	    // Obtener la URL actual
	    const currentUrl = window.location.href;
	    // Crear un objeto URL
	    const url = new URL(currentUrl);
	    // Eliminar el parÃ¡metro 'token' de la query string
	    url.searchParams.delete('token');
	    // Obtener el pathname sin el token
            const urlWithoutToken = url.pathname.split('/').pop();
	    const recipeCalificadaOk = {
	        recipeId: recipeId,
		url: urlWithoutToken,
	        date: new Date().toISOString()
	    };
	    try {
	        const response = await fetch('https://www.refactorii.com/updateOneGoogleSigninUserRecipe', {
	            method: 'POST',
	            headers: {
	                'Content-Type': 'application/json'
	            },
	            //body: JSON.stringify({ Email: email, recipeCalificadaOk: recipeId })
		    body: JSON.stringify({ Email: email, recipeCalificadaOk })	
	        });
	        const data = await response.json();
	        console.log('Server responds:', "Ok");
		// RedirecciÃ³n a la pÃ¡gina original
                window.location.href = `https://www.refactorii.com/recipes/${recipeId}`;
	    } catch (error) {
	        console.error('Error sending the results to the server:', error);
	    }
    }

    function decodeJwtResponse(token) {
	    var base64Url = token.split('.')[1];
	    var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
	    var jsonPayload = decodeURIComponent(window.atob(base64).split('').map(function(c) {
	        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
	    }).join(''));
	    return JSON.parse(jsonPayload);
    }
    </script>
</body>
</html>
